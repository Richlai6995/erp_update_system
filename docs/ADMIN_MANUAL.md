# ERP 程式更新系統 - 系統管理員手冊 (Admin Manual)

本手冊僅供**系統管理員 (Admin)** 與 **資料庫管理員 (DBA)** 使用。

## 目錄
1.  [使用者與部門管理](#1-使用者與部門管理)
2.  [簽核作業](#2-簽核作業)
3.  [程式佈署 (Deploy)](#3-程式佈署-deploy)
4.  [編譯與上線](#4-編譯與上線)
5.  [系統設定與日誌](#5-系統設定與日誌)
6.  [備份機制說明](#6-備份機制說明)

---

## 1. 使用者與部門管理

進入「系統管理」頁面：
*   **使用者管理**：
    *   可檢視所有使用者列表。
    *   **同步 AD 使用者**：新進人員首次登入失敗時，系統會自動在資料庫建立帳號 (狀態為 Inactive)，管理員需手動啟用並設定部門與權限。
    *   **權限設定**：可設定 Admin (全權), DBA (佈署權限), Manager (簽核權限) 或一般使用者。
*   **部門管理**：
    *   設定各部門名稱及其**簽核主管**。請務必設定正確，否則簽核通知信無法寄送。

## 2. 簽核作業

當申請單狀態為 `Reviewing` (簽核中) 時：
*   **主管 (Manager)**：可執行「同意 (Approve)」或「退回 (Reject)」。
    *   同意：案件轉交 DBA。
    *   退回：案件退回給申請人 (狀態變為 `Manager Rejected` - 主管退回)，申請人可修改後重送。
*   **管理員 (Admin)**：擁有最高權限，可代理執行所有簽核動作 (包含作廢)。

## 3. 程式佈署 (Deploy)

當申請單狀態為 `Approved` (已核准) 時，DBA 可進入申請單執行佈署：
1.  **程式佈署 (Deploy)**：
    *   點擊藍色 **「程式佈署」** 按鈕。
    *   系統會透過 SFTP 將檔案上傳至 ERP 伺服器對應路徑。
    *   **路徑規則**：依據 `ERP_MODULES` 設定與檔案副檔名自動判斷 (如 `FORM` -> `$AU_TOP/forms/T`, `REPORT` -> `$AU_TOP/reports/T`)。

## 4. 編譯與上線

*   **程式編譯 (Compile)**：
    *   點擊金色 **「程式編譯」** 按鈕 (僅限 Form/Library 類型)。
    *   系統會觸發遠端編譯指令 (frmcmp_batch)。
*   **DBA 上線 (Online)**：
    *   點擊青色 **「DBA 上線」** 按鈕。
    *   此動作代表作業完成，系統將發送結案通知信給申請人，並將單據狀態改為 `Online` (已上線)。

## 5. 系統設定與維護

點擊 **「系統設定」** 按鈕開啟管理視窗，包含以下功能頁籤：

### 5.1 部門設定 (Departments)
*   **功能**：管理各部門基本資料與簽核流程。
*   **操作**：
    *   **新增/編輯部門**：設定部門代碼 (Code) 與名稱。
    *   **簽核設定**：點擊 **「簽核設定」** 可定義該部門的多階簽核流程。
        *   **順序 (Step)**：設定簽核順序 (1, 2, 3...)。
        *   **簽核人員**：指定該階層的簽核者 (可為 Manager)。
        *   **通知**：勾選後，該階層審核時會收到 Email 通知。

### 5.2 ERP 模組設定
*   **功能**：設定 ERP 模組代碼與對應的伺服器路徑。
*   **全域路徑 (Global Paths)**：
    *   設定 Form, Report, SQL, Library 的基礎路徑 (例如 `$AU_TOP/forms/T/*`)。
    *   `*` 符號將會被模組的 **Path Code** 自動替換。
*   **模組列表**：
    *   新增模組時，需輸入 Code (如 `GL`) 與 Path Code (如 `gl`)。
    *   系統會自動預覽並生成最終的佈署路徑。

### 5.3 DB 物件類別
*   **功能**：定義申請單中「DB Object」可選擇的物件類型。
*   **範例**：`Table`, `View`, `Procedure`, `Package`, `Trigger` 等。
*   只有在此列表中的類別，使用者在申請時才能選擇。

### 5.4 資料庫維護
*   **備份設定**：
    *   可設定自動備份頻率 (每日/每週/每月)。
    *   **立即手動備份**：點擊按鈕可立即觸發備份。
*   **備份列表**：顯示伺服器上的備份檔案。
    *   **下載**：將 `.db` 備份檔下載至原本機。
    *   **一般還原**：還原至該時間點 (若目標已存在則覆蓋)。
    *   **強制還原**：**「危險操作」**，將強制覆蓋目前所有資料庫內容。
*   **系統還原 (匯入)**：
    *   上傳並匯入 `.db` 檔，此動作會**完全清除並覆蓋**現有資料，請謹慎使用。

### 5.5 郵件伺服器管理
*   **狀態控制**：可手動開啟 (ON) 或關閉 (OFF) 郵件伺服器。關閉期間系統將不會發送任何通知信。
*   **日誌維護 (Log Maintenance)**：
    *   **自動保留天數**：設定日誌保留天數，過期自動清除。
    *   **手動清除**：可指定日期清除舊日誌，或清除全部。
*   **寄信紀錄 (Logs)**：檢視系統發出的所有郵件紀錄 (成功/失敗、收件人、主旨)。

### 5.6 環境變數 (Env)
*   **注意**：此處修改的是系統核心設定 (`.env`)。修改連線資訊後，**必須重新啟動後端伺服器 (Restart Server)** 才會生效。
*   **設定項目**：
    *   **SMTP 郵件伺服器**：Host, Port, 帳號密碼。
    *   **LDAP 認證設定**：AD 網域連線資訊。
    *   **ERP 連線 (SSH/FTP)**：用於 Deploy (FTP) 與 Compile (SSH) 的連線資訊。
    *   **ERP 資料庫**：Oracle DB 連線資訊 (用於 DB Object 佈署)。

## 6. 備份機制說明

系統在佈署檔案覆蓋舊檔時，會自動執行備份：
*   **備份檔名**：`原檔名_BK_BY_申請單號_申請人.副檔名`
*   **衝突處理**：若該備份檔名已存在 (例如同單號重複佈署)，系統採 **「保留舊備份」** 策略。
    *   系統會跳過備份建立步驟 (Log: `Skipping backup creation`)。
    *   直接以新檔案覆蓋目標檔案。
    *   此舉確保最早的備份檔不會被後續的重複操作覆蓋。

---
## 7. 進階維護與故障排除

### 7.1 變更系統設定注意事項 (System Settings)

當您在「系統設定 > 環境變數 (Env)」修改參數 (如 LDAP 密碼、SMTP 設定、ERP 連線資訊) 並儲存後，系統會告知「請重新啟動後端伺服器」。

這是因為 Node.js 服務是在啟動時讀取設定檔，此設定是注入到容器環境變數中。**修改後的參數必須重建容器才能生效**。

**操作步驟：**
1.  登入伺服器 Terminal。
2.  進入專案目錄 (例如 `cd /path/to/erp_update_system`)。
3.  執行重建指令 (此指令會讀取新的 .env 並重新建立容器)：
    ```bash
    docker compose up -d
    ```
4.  檢查日誌確認啟動成功：
    ```bash
    docker logs -f erp_update_system
    ```

### 7.2 清除所有申請單據 (Reset Requests)

若需要**完全清除系統中的所有申請單** (例如測試完畢要建立乾淨的正式環境)，請使用專用的清除腳本 `reset_requests.js`。

**警告：此操作不可逆，將會永久刪除所有申請單、附件與簽核紀錄。**

**操作步驟：**

1.  確認 `server/reset_requests.js` 檔案已存在於伺服器上 (若無，請將其複製到 `server/` 目錄)。
2.  **進入 Docker 容器執行腳本** (確保直接操作資料庫)：
    ```bash
    # 1. 進入容器 Shell
    docker exec -it erp_update_system /bin/sh

    # 2. 執行清除程式 (請確保您知道自己在做什麼)
    node server/reset_requests.js

    # 若成功，螢幕將顯示 "[Cleaner] Data cleared successfully."
    
    # 3. 離開容器
    exit
    ```
3.  **重啟容器 (非常重要)**：
    因為資料庫是載入記憶體執行的，**清除後必須重啟容器**，Server 才會重新讀取乾淨的資料庫檔。
    ```bash
    docker compose restart
    ```

---
**機密警語**：本手冊僅供內部使用，請勿外流。管理員操作涉及系統核心權限，執行刪除或佈署動作前請務必再次確認。
