# 正崴雲端智慧發信系統 - 系統管理員手冊 (Administrator Manual)

本手冊專供系統管理員 (Admin) 使用，說明如何管理使用者帳號、監控系統運行狀態、設定郵件伺服器以及維護資料庫安全。

---

## 目錄

1.  [系統架構概覽](#1-系統架構概覽)
2.  [使用者管理 (User Management)](#2-使用者管理-user-management)
3.  [郵件日誌監控 (Mail Logs)](#3-郵件日誌監控-mail-logs)
4.  [資料庫維護](#4-資料庫維護)
5.  [系統部署與環境變數](#5-系統部署與環境變數)

---

## 1. 系統架構概覽

本系統基於前後端分離架構設計：
*   **前端**：React + Tailwind CSS (Port 5173 / Production Build)
*   **後端**：Node.js + Express (Port 3002)
*   **資料庫**：SQLite (儲存使用者、範本、日誌與專案結構)
*   **驗證服務**：LDAP (AD 連線) + JWT Token
*   **AI 服務**：Google Gemini API

管理員介面入口：登入後，點擊左側選單底部的「**系統管理**」(Admin Dashboard)。

---

## 2. 使用者管理 (User Management)

管理員可在此區塊審核帳號、重置密碼及設定 AI 使用權限。

### 2.1 帳號列表與狀態
進入「使用者管理」頁面，您會看到所有註冊使用者列表。
*   **狀態 (Status)**：
    *   `Active`: 帳號正常啟用中。
    *   `Inactive`: 帳號已停用或尚未開通 (新註冊的 Local 帳號預設為 Inactive)。

### 2.2 審核新帳號
當有員工無法使用 AD 登入並註冊了內部帳號後：
1.  找到狀態為 `Inactive` 的使用者。
2.  點擊右側的「**編輯**」按鈕。
3.  將狀態改為 `Active`。
4.  儲存後，該員工即可登入。

### 2.3 AI 權限控管 (AI Access)
考量 Token 本成本，您可以個別開啟或關閉使用者的 AI 使用權限。
*   **啟用 AI**：勾選 `Use AI` 選項 -> 使用者可看到並使用 AI 助手。
*   **停用 AI**：取消勾選 -> 使用者介面上的 AI 圖示將隱藏。

### 2.4 重置密碼
*   僅限 **Local 帳號** 可由管理員重置密碼。
*   AD 帳號密碼由公司網域控管，本系統無法修改。

---

## 3. 郵件日誌監控 (Mail Logs)

系統會詳細記錄每一封由「郵件範本系統」發出的信件。

### 3.1 查看日誌
進入「**郵件紀錄**」頁面，您可以查看：
*   **發送時間**：精確到秒。
*   **執行者**：是哪位員工操作了發送。
*   **專案/路徑**：該郵件是基於哪個專案與日期資料夾產生的。
*   **收件人/主旨/狀態**：發送是否成功。

### 3.2 故障排除
若狀態顯示 `Failed`，請點擊詳情查看錯誤代碼。常見原因：
*   SMTP 連線逾時 (請檢查網路或 VPN)。
*   附件檔案過大或路徑錯誤。
*   收件人信箱格式錯誤。

---

---

## 4. 資料庫維護

系統採用 SQLite 作為核心資料庫。為了確保資料安全，系統提供了手動與自動備份機制。

### 4.1 自動備份設定 (Auto Backup)
系統支援定期將資料庫備份至指定的伺服器路徑 (Server Path)。
1.  進入「系統管理」>「資料庫維護」。
2.  在「**系統自動備份設定**」區塊中，您可以設定：
    *   **備份頻率**：
        *   `不自動備份`：僅依賴手動觸發。
        *   `每天 (Daily)`：每日凌晨 02:00 執行。
        *   `每週 (Weekly)`：每週日凌晨 02:00 執行。
        *   `每月 (Monthly)`：每月 1 號凌晨 02:00 執行。
    *   **儲存設定**：選擇頻率後，務必點擊「儲存設定」按鈕。
3.  **備份檔案列表**：下方表格會列出目前伺服器上所有已存檔的備份 (`.db`)。您可以直接在此介面進行：
    *   **下載**：將備份檔下載至本地電腦。
    *   **一般還原**：使用該備份檔覆蓋目前資料庫。
    *   **強制還原**：若資料庫嚴重損毀，使用此選項強制覆寫。
    *   **手動執行**：點擊紫色的「**立即手動備份**」按鈕，可立即產生一份當下的備份檔。

### 4.2 手動匯出與還原
除了自動排程，您也可以使用傳統的匯出/匯入功能 (Manual Export/Import) 來進行單次性的備份與遷移。

---

## 5. 郵件伺服器管理與日誌維護

### 5.1 郵件伺服器開關
在「**郵件伺服器管理**」頁籤中，管理員可以一鍵開啟或關閉全系統的寄信功能。
*   **ON (綠燈)**：正常運作，系統可發信。
*   **OFF (紅燈)**：維護模式，所有寄信請求將被拒絕並記錄為 Failed。

### 5.2 郵件日誌自動清除 (Auto Cleanup)
為了避免 `mail_logs` 資料表無限膨脹影響效能，系統內建自動清除機制：
*   **設定保留天數**：
    *   預設為 `30` 天。
    *   您可以修改此天數並儲存。
*   **自動執行機制**：
    *   系統會**每小時 (Hourly)** 自動執行一次檢查。
    *   檢查時，會刪除所有「**超過保留天數**」的舊日誌。
    *   例如：設定保留 2 天，系統每小時會刪除 48 小時以前的所有紀錄。
*   **手動清除**：您也可以指定日期，手動一鍵清除該日期之前的所有紀錄。

---

## 6. 系統部署與環境變數

若需遷移伺服器，請確保 Docker 環境配置正確。

*   **Dockerfile**：定義系統映像檔。
*   **docker-compose.yml**：定義服務運作參數。
*   **關鍵環境變數 (.env)**：
    *   `LDAP_URL`: AD 伺服器位置 (如 `ldap://192.168.x.x`)。
    *   `GEMINI_API_KEY`: AI 服務金鑰。
    *   `FILES_ROOT_DIR`: 實體檔案儲存路徑 (對應到 Docker Volume)。

**備份路徑配置 (system.yaml)**
位於 `server/config/system.yaml`，定義備份檔案的儲存位置：
```yaml
backup_path: "/app/backups" # Docker 容器內的實際掛載路徑
backup_display_path: "E:\\backup_file\\file_management_system_db" # 前端顯示給使用看的路徑
```

---
*文件版本：v1.1.0 | 最後更新：2026-01-13*
